---
title: Consensus Authoring
description: Authoring restrictions related to consensus
duration: 30min
---

# 共识：出块

---v

### 共识是...

...一个决策过程，旨在让所有参与者都接受某个决策。

---v

## 区块链共识是...

...一个去中心化的共识系统，用于就状态机的共享历史达成一致。

---v

## 区块空间

<img style="width: 00px" src="./img/blockspace-machine.svg" />

区块链共识系统产生一种称为区块空间的资源。

强烈的激励一致性和强有力的保障能带来高质量的区块空间。

Notes:

正如我们所讨论的，区块空间代表着对共享历史做出贡献的权利。
这是一种有价值的资源，作为产品提供给用户。
我们将在后续关于分配和费用的讲座中讨论这种资源的出售。
所使用的共识系统在决定区块空间的质量方面起着重要作用。

---

## 分叉回顾

<img style="width: 500px" src="./img/forks-some-invalid.svg" />

将会出现分叉。
我们需要决定哪一个是真正的链。

我们可以排除一些分叉，以缩小问题范围。
然后我们需要决定哪一个是规范的链。

Notes:

分叉代表着历史可能采取的不同路径。
每当出现意见分歧时，就会产生分叉。

你可以从社会层面来思考分叉。
法庭案件、争论、战争。
理想情况下，我们可以和平地解决这些分歧。

你也可以从非常低的物理层面来思考分叉。
每次电子遇到势垒时，它要么反射，要么隧穿。
当共识具有高质量时，其结果就像物理过程的结果一样客观。

---

## 共识的五个方面

<pba-flex center>

- 状态机有效性
- 任意性/政治性有效性
- 出块节流
- 分叉选择启发式
- 最终确定性

</pba-flex>

Notes:

前两个方面相对简单，我现在简要讨论一下。
第三和第四个方面是本次讲座的主要主题。
第五个方面将在两节课后详细讨论。

前三个方面是关于排除可能性。
第四和第五个方面是关于在剩余的可能性中做出决定。

---v

## 状态机有效性

有些分叉可以简单地因为包含无效的状态转换而被排除。

<img style="width: 00px" src="./img/invalid-state-transition.svg" />

Notes:

例如，花的钱比你拥有的多。
记录你的当前位置，使得自上次记录以来你的移动速度超过了光速。
用无效参数调用智能合约。

---v

## 任意性/政治性有效性

与状态机有效性类似。<br />
示例：

<pba-flex>

- 区块太大
- 包含“黑客”交易的区块
- 空区块
- 具有偶数状态根的区块

</pba-flex>

<img style="width: 00px" src="./img/politically-invalid-state-transition.svg" />

Notes:

这个概念与上一张幻灯片类似。
在某种意义上，这甚至是相同的。
这使我们能够排除一些不具备我们所喜欢的属性的分叉。
或者排除那些具有我们不喜欢的属性的分叉。

不是每个人都会同意这些属性，这会导致长期的网络分裂。

---

## 出块节流

现实世界中的区块链对谁可以创作区块施加了额外的限制。
为什么呢？

<img style="width: 00px" src="./img/fork-chaos.svg" />

Notes:

这些区块链应该是无需许可的，对吧？至少其中很多是这样。
有些甚至非常坚定地追求这个目标。
那么，我们为什么要限制出块呢？
答案是：为了不让节点不堪重负。
无节制的出块会导致分叉混乱。
如果任何人在任何时候都可以创作区块，那么区块就会像雨点一样四处落下。
要检查所有这些区块是不可能的。
这将成为拒绝服务攻击（DOS）的中心。
所以我们需要对这个过程进行一些组织和排序。

---v

## 领导者选举

我们需要选出一小部分（理想情况下是单个）实体，允许他们接下来进行出块。

在区块链共识出现之前，这被称为“领导者”，现在仍然经常这样称呼。

Notes:

通过选出少数领导者，我们能够对出块进行节流。

---v

## 活性

系统持续创作新区块的能力

Notes:

在继续之前，我想介绍一下活性的概念。
这是共识系统所期望具备的一个属性。
具有更好活性属性的系统能够提供更高质量的区块空间。
没有活性保证的链会陷入停滞。

---

## 工作量证明

中本聪的伟大发明。

解决一个原像搜索问题 - 获得出块的权利。

---v

## 工作量证明：优点

<pba-flex center>

- 无需许可（或者我们曾经这么认为）
- 需要一种外部稀缺资源：能源
- 盲选：在发布区块的那一刻之前，没有人知道下一个出块者是谁
- 出块竞争分叉的成本高昂 - 有明确的激励机制

</pba-flex>

Notes:

从表面上看，工作量证明的一个重要优势是，任何人都可以启动一个节点，并在无需任何人许可的情况下随时加入。
这显然是白皮书中所描述的方式。
但在实践中，现在许多系统的哈希率非常高，以至于你的家用计算机毫无用处。
现在，它是由谁能够负担得起并获得合适的硬件来决定是否有许可的。

对外部资源的依赖在某种意义上是有好处的，因为它是市场对共识系统估值的一个客观衡量标准。
这有助于对区块空间进行估值。

盲选是一个很好的属性，因为它使得对下一个领导者进行有针对性的攻击（拒绝服务攻击或物理攻击）以阻碍网络变得不可能。

一些攻击依赖于领导者出块两个竞争分叉，并将它们传播到网络的不同部分。
在工作量证明中，你创作的每个区块都需要消耗能源。
这使得进行此类攻击的成本很高。
这为出块者提供了一种经济激励，使其只在“正确”的分叉上创作区块。

---v

## 工作量证明：缺点

<pba-flex center>

- 能源消耗大
- 区块时间不规律
- 并非真正无需许可

</pba-flex>

Notes:

能源消耗通常被认为是一个负面属性。
有时被称为“浪费证明”。
我不会走得那么远，但在气候变化成为现实的世界里，如果我们可以用更少的能源来解决问题，那么消耗这么多能源肯定不是理想的。

值得注意的是，一些工作量证明方案（例如门罗币的方案）试图通过选择“抗ASIC”的算法来最小化能源影响。
虽然这些方案明显比比特币的方案要好，但它们并没有从根本上解决问题。
只是在实践中有所缓解。

其次，区块时间只是在概率上可知。
在等待区块被创作时，有时会出现区块爆发，随后又会有很长一段时间没有区块。

虽然从表面上看它似乎是无需许可的，但在实践中，要成为一名比特币矿工，你需要拥有昂贵的专用硬件。

---v

## 为什么要进行出块呢？

- 利他主义 - 你因为让世界变得更美好而感到高兴
- 你的交易 - 因为你想让自己的交易被记录
- 明确的激励措施 - 例如区块奖励

Notes:

如果创作区块需要消耗能源，那么为什么会有人一开始就想进行出块呢？

在你想让自己的交易被记录时才进行挖矿，在我看来是个不错的主意。
那些不想自己进行出块的人，可以支付费用让别人为他们做。
这就是交易费用的目的。
大多数链在交易本身中就规定了交易费用，这些费用会支付给出块者。

一些网络还会添加明确的激励措施，例如每个区块有50比特币的奖励。

---

## 权威证明

传统的一类解决方案。

将时间划分为时隙。

某些身份在每个时隙中被允许进行出块。

用签名证明你的身份。

---v

## 权威证明：优点

<pba-flex center>

- 能源消耗低
- 稳定的区块时间

</pba-flex>

Notes:

稳定的区块时间是高质量区块空间的一个属性。
它允许消耗区块空间的应用程序对吞吐量有预期。
在工作量证明中，你偶尔会遇到很长一段时间没有区块的情况，这会对应用程序产生负面影响。

---v

## 权威证明：缺点

<pba-flex center>

- 需要许可
- 没有外部资源辅助估值
- 诚实的激励机制并不总是明确的

</pba-flex>

Notes:

如果他们行为不当，会有什么不好的事情发生吗？并非必然如此。
我们需要一种激励措施来确保这一点。

---

# 一些权威证明方案

提醒：权威证明是一类领导者选举方案

---v

## Aura

简单的一种方案。

每个人按顺序轮流进行。

```rust
authority(slot) = authorities[slot % authorities.len()];
```

Notes:

优点：

- 简单
- 每个时隙中选出一个领导者

缺点：

- 不具备盲选特性 - 容易受到有针对性的攻击

---v

## Babe

**B**lind **A**ssignment for **B**lockchain **E**xtension

- 在每个时隙中，计算一个可验证随机函数（VRF）的输出。
- 如果输出低于一个阈值，你就有资格进行出块。 <!-- .element: class="fragment" data-fragment-index="2" -->
- 如果有资格，出块一个包含VRF证明的区块 <!-- .element: class="fragment" data-fragment-index="3" -->
- 如果没有资格，什么都不做 <!-- .element: class="fragment" data-fragment-index="4" -->

Notes:

优点：

- 没有固定顺序有助于缓解拒绝服务攻击

缺点：

- 有些时隙没有出块者 - 对此有一个变通办法。
- 其他时隙有多个出块者，这会导致分叉 - 对此**没有**变通办法。

---v

## Sassafras

<pba-cols>
<pba-col>
<img rounded style="width: 500px" src="./img/Sassafras-albidum.jpg" />
</pba-col>
<pba-col>

基于单个盲选可验证随机函数的领导者选举

🙈说实话，我不知道它内部是如何工作的。 <!-- .element: class="fragment" data-fragment-index="2" -->

但杰夫知道！ <!-- .element: class="fragment" data-fragment-index="3" -->

</pba-col>
</pba-cols>

Notes:

- 具有工作量证明的大部分优点（除了基于外部资源的估值提示之外）
- 具有权益证明的所有优点

---v

## Sassafras类比

<pba-cols>
<pba-col>
<img rounded style="width: 500px" src="./img/jeff.jpeg" />
</pba-col>
<pba-col>

> Sassafras有点像《反人类牌》游戏

</pba-col>
</pba-cols>
---v

## Sassafras类比

<img rounded width="400px" style="float: left; padding: 1px;" src="./img/caa_black.png" />
<img rounded width="400px" style="float: left; padding: 1px;" src="./img/caa_white_1.png" />
<!-- .element: class="fragment" data-fragment-index="2" -->
<img rounded width="400px" style="float: left; padding: 1px;" src="./img/caa_white_2.png" />
<!-- .element: class="fragment" data-fragment-index="3" -->

---v

## Sassafras类比

<pba-cols>
<pba-col>
<img rounded width="500px" src="./img/jeff.jpeg" />
</pba-col>
<pba-col>
<blockquote style="font-size: 80%">环形可验证随机函数的输出就像“牌”。 你匿名“打出”手中最好（也就是最小）的牌。</blockquote>
<!-- .element: class="fragment" data-fragment-index="2" -->
<blockquote style="font-size: 80%">这些牌会被排序，由于它们只是数字，所以不是按趣味性排序，而是按数字大小排序。</blockquote>
<!-- .element: class="fragment" data-fragment-index="3" -->
<blockquote style="font-size: 80%">它们最终的顺序就是区块的生成顺序。</blockquote>
<!-- .element: class="fragment" data-fragment-index="4" -->
<blockquote style="font-size: 80%">你通过进行一个具有相同输出的非环形可验证随机函数来认领属于你的牌。</blockquote>
<!-- .element: class="fragment" data-fragment-index="5" -->
</pba-col>
</pba-cols>

---v

# 权益证明
它其实是伪装后的权益权威证明（PoA）🤯。

权益证明通过一种经济质押博弈来挑选出记账人。
它至少将无许可特性恢复到了工作量证明（PoW）的水平。
同时恢复了清晰的经济激励机制。

Notes:
在状态机中，有一个名为质押的经济博弈，它可以挑选出参与权益权威证明方案的记账人。
实际上，实现方式并非只有一种，而是有很多种。
之后基恩（Kian）会详细讲解这个内容以及波卡（Polkadot）中的实现方式。
现在我先大致介绍一下。
其基本思路是，任何人都可以在链上（状态机中）锁定一些代币。
质押代币最多的参与者会被选为记账人。
状态机中有一个状态转换机制，可用于举报记账人的不当行为（例如在同一高度创建竞争区块），出现此类行为记账人将失去他们的代币。
和工作量证明一样，通常也会有区块奖励。
---v
## 💒 共识 🪢 状态机
- 共识和状态机之间的松散耦合很常见
- 例如区块奖励、罚没机制、记账人选举
- 在工作量证明中有难度调整算法
在Substrate中，有一个**运行时应用程序编程接口（Runtime API）**的概念——共识机制可以从状态机中读取信息。
<!-- .element: class="fragment" data-fragment-index="2" -->
Notes:
到目前为止，我把共识描述为与状态机正交的概念。
这在很大程度上是正确的。
但在实践中，它们之间存在一些松散耦合是极为常见的。
我们在讨论区块奖励时已经看到了一个例子。
共识机制下的记账人因为创建区块而获得代币奖励（在状态机中）。
现在我们看到，他们也可能因为违反共识协议而被扣除代币（在状态机中）。
并且我们发现，甚至记账人本身都可以在状态机中选举产生。
---
# 分叉选择启发式
每个节点对于哪个分叉最优的偏好
<pba-flex center>
- 最长链规则
- 最多累计工作量
- 由爱丽丝创建的最多区块
- 最多总交易数（或最多消耗gas）
<img style="width: 500px" src="../finality/img/reorgs-1.svg" />
</pba-flex>
Notes:
分叉选择使作为网络参与者的你，能够决定当前你认为哪个分叉最优。
这并非是固定不变的。
随着你在网络上看到更多区块出现，你的看法可能会改变。
---v
## 区块链重组
<img style="width: 500px" src="../finality/img/reorgs-1.svg" />
<img style="width: 500px" src="../finality/img/reorgs-2.svg" /> <!-- .element: class="fragment" data-fragment-index="2" -->
被丢弃的交易重新进入交易池，并很快重新出现在新区块中 <!-- .element: class="fragment" data-fragment-index="3" -->
Notes:
随着看到更多区块出现，我们现在对哪条链最优有了不同的看法。
这被称为区块链重组。
区块链重组几乎是不可避免的。
虽然有办法确保它们根本不会发生，但完全防止它们需要付出巨大代价。
通常，短的区块链重组不是大问题，但深度重组则是。
你也可以从社交层面体会到这一点。
- 想象你在等同事提交一篇论文。
  你以为他们昨天已经提交了，但结果他们今天才提交，或者要等到明天才提交。
  这可能会让人有点恼火，但通常不会造成灾难性后果。
- 想象你以为同事几个月前就提交了论文，而且论文已经发表。
  你在求职时已经把这篇论文列为成果。
---v
## 双花攻击
<img style="width: 800px" src="./img/double-spend-1.svg" />
Notes:
这个名字来源于比特币，但这种攻击具有普遍性。
它利用了区块链分叉的存在。
攻击者必须将两笔冲突的交易放入两个分叉中。
并在对方看到区块链重组之前，说服交易对手相信其中一条链足够长时间，从而采取链下行动。
---v
## 双花攻击
<img style="width: 800px" src="./img/double-spend-2.svg" />
---
## 共识的五个方面
<pba-flex center>
- 状态机有效性
- 任意性/政治性有效性
- 记账限制
- 分叉选择启发式
- 最终确定性
</pba-flex>
Notes:
我们刚刚讨论了前四个方面。
最终确定性将在后续课程中讨论。 